# AI 作业批改 Web 工具 · 程序设计说明书（PDR）

## 一、项目概述

### 1.1 项目名称

* 中文名称：AI 作业批改 Web 工具
* 英文参考名：AI Homework Grader (仅内部用)

### 1.2 项目背景

教师/助教在本地已经收集好一批学生的 Word 作业（.docx），希望可以：

* 一次性上传多个作业文件
* 自动识别哪些文件能解析、哪些文件有问题
* 对可解析的作业调用大模型生成「分数 + 评语」
* 将所有结果导出为 Excel，以便成绩录入和存档

项目定位为：本地轻量级工具，功能以「能用」为标准，而不是面向商用部署或复杂架构。

### 1.3 目标与范围

目标：

1. 提供一个简单的 Web 页面，教师在浏览器中完成全部操作：

   * 上传作业文件
   * 配置大模型 API 信息及评分参数
   * 一键执行批改流程
   * 下载成绩表与异常文件列表
2. 后端使用 Python 实现，逻辑清晰，便于后续你自己扩展。
3. 不做复杂用户体系、权限管理等，仅面向单机、单用户使用。

范围（本次版本）：

* 支持上传本地 .docx 作业文件（多文件）。
* 支持本地解析 docx 正文、基础清洗。
* 支持调用外部大模型 API（如 HTTP 接口），获取评分 JSON。
* 支持将结果写成 Excel 文件并提供下载。
* 支持查看异常文件列表（解析失败或模型失败）。

---

## 二、模块清单与功能范围

从系统角度拆成几个模块，你以后写代码就按这个拆类/拆文件。

### 2.1 Web 界面模块（前端）

职责：提供给教师/助教使用的浏览器界面。

主要功能：

* 作业文件上传区域

  * 支持多选上传（多文件）
  * 显示已选文件列表（文件名、大小）
* 配置输入区域

  * 模型 API 地址
  * API Key
  * 评分模式选择（如职业规划作业 / 调研报告作业，可选）
* 执行控制

  * “开始批改”按钮
  * 显示总体进度（已处理文件数 / 总数）
  * 显示当前处理状态（如“解析文件中 / 调用模型中 / 导出结果中”）
* 结果展示与下载

  * 显示简单统计：总文件数、成功评分数、异常文件数、平均分等
  * 提供两个下载链接：

    * 成绩表 Excel（grade_result.xlsx）
    * 异常文件清单 Excel 或 CSV

范围限制：

* 不做复杂的前端框架（如 React/Vue），可用简单 HTML + CSS + 少量 JavaScript。
* 不做用户登录/权限管理。

### 2.2 文件上传与管理模块（后端）

职责：接收前端上传的多个 docx 文件，统一管理临时存储。

主要功能：

* 接收多文件上传（multipart/form-data）
* 为当前批次生成唯一批次 ID（如日期时间 + 随机串）
* 将上传文件保存到后端的临时目录：

  * 路径示例：./data/uploads/{batchId}/
* 记录每个文件的元信息（FileMeta）：

  * 批次 ID
  * 文件名
  * 后端存储路径
  * 推测出来的学号 / 姓名（从文件名解析，可选）

范围限制：

* 不做长期存储，不考虑多用户并发批改，默认一次只处理一个批次。

### 2.3 文件解析与校验模块

职责：判断上传文件是否为可处理的 docx，并抽取正文文本。

主要功能：

* 文件格式校验：

  * 确认扩展名为 .docx
  * 使用 python-docx 或类似库尝试打开
* 内容解析：

  * 遍历段落并拼接为纯文本
  * 可适度过滤明显无意义内容（页眉页脚标记、空行等）
* 校验规则：

  * 若文件损坏 / 不是有效 docx / 无法解析，则标记为异常文件
  * 若解析后正文字数过少（例如 < 50 字），判定为内容异常
* 产出：

  * 可处理文件列表：附带解析出的正文文本
  * 异常文件列表：记录原因（格式错误 / 解析失败 / 正文为空等）

范围限制：

* 仅支持 .docx，不处理 pdf、jpg 等。
* 文本清洗仅做基础处理，不做复杂 NLP 预处理。

### 2.4 AI 内容评分模块

职责：对每个可处理的作业正文调用大模型，生成标准化评分结构。

主要功能：

1. Prompt 构造：

   * 将评分说明（固定模版） + 学生正文拼接成请求内容：

     * 评分总分 0~100
     * 若干维度分（结构 / 内容 / 表达）
     * 要求返回指定 JSON 结构

2. 调用大模型 API：

   * 使用 Python requests / httpx 向外部模型服务发起 HTTP 请求
   * 支持配置：

     * API URL
     * API Key
     * 模型名称（可选）
   * 设置超时与简单重试（例如失败重试 1~2 次）

3. 解析模型返回：

   * 期望返回为 JSON 格式，结构示例：

     * score: 数值，0~100，可小数
     * comment: 字符串，总评语
     * dimensions: 对象，包含多个维度评分
   * 若返回文本不是合法 JSON，尝试修复（去掉前后多余文字）后再解析
   * 若仍无法解析，则将该文件标记为“模型错误”

4. 生成评分记录 GradeRecord：

   * 绑定文件信息 + 分数 + 评语 + 维度分 + 状态

输出数据结构概要（逻辑层面）：

* GradeRecord：

  * fileName
  * studentId（从文件名猜测）
  * studentName（同上）
  * rawTextLength（正文字数）
  * score（0~100）
  * comment（文本评语）
  * dimensions（如 structure/content/expression 的分数）
  * status（OK / MODEL_ERROR / PARSE_ERROR 等）
  * errorMessage（如有）

范围限制：

* 不在后端实现大模型，只负责调用外部 API。
* 不做异步队列，仅在单机同步处理，后续可扩展为多线程。

### 2.5 结果汇总与导出模块

职责：把所有评分记录与异常文件统一汇总为可下载结果。

主要功能：

* 成绩表生成（Excel）：

  * 使用 openpyxl 或 xlsxwriter 生成 grade_result.xlsx
  * 列字段示例：

    * 学号
    * 姓名
    * 文件名
    * 总分
    * 各维度分
    * 正文字数
    * 状态
    * 错误信息
* 异常文件清单生成：

  * 生成 error_files.xlsx 或 CSV：

    * 文件名
    * 错误类型
    * 错误说明
* 文件下载接口：

  * 提供后端 HTTP 接口让前端下载对应文件。
* 简要统计：

  * 总文件数
  * 成功评分数
  * 异常文件数
  * 平均分（仅统计成功评分的记录）

范围限制：

* 不做可视化图表，统计信息只在 Web 页简单展示。
* 不对历史批次做复杂管理，默认以最新批次为主。

### 2.6 配置管理模块

职责：管理前端和后端的可配置项。

主要功能：

* 前端配置：

  * 将用户输入的 API URL / API Key / 评分模式保存在 localStorage，便于下次自动带出。
* 后端配置：

  * 基础配置文件（如 config.yaml）：

    * 批次数据保存目录
    * 临时文件清理策略（例如保留天数）
* 安全性：

  * API Key 只在前端输入、通过 HTTPS 请求传给后端调用，不保存到后端磁盘（或者仅临时保存在进程内存）。

### 2.7 日志与异常处理模块

职责：记录系统运行日志，便于排查问题。

主要功能：

* 记录每次批改批次的核心信息：

  * 批次 ID
  * 文件数、成功数、失败数
  * 开始时间与结束时间
* 对模型调用、文件解析等关键步骤记录错误日志：

  * 错误类型
  * 异常信息
  * 相关文件名

范围限制：

* 使用 Python 内置 logging 写到本地文本日志即可，不做日志系统。

---

## 三、技术架构设计

### 3.1 整体架构

采用典型的本地 B/S 架构：

* 前端：浏览器中的 Web 页面（HTML + CSS + 原生 JS）
* 后端：本机运行的 Python Web 服务（建议 Flask 或 FastAPI）
* 数据与文件：存放在本机磁盘，按批次划分目录

简单结构示意：

浏览器（教师/助教）
↓ HTTP
Python Web 服务（Flask/FastAPI）
↓ 本地文件操作 / 大模型 HTTP API / SQLite（可选）
本机文件系统 + 可选本地数据库

### 3.2 后端框架选型

* Web 框架：

  * Flask 或 FastAPI（任选一个你熟的）
  * 提供 API：

    * POST /api/upload-files
    * POST /api/start-grading
    * GET /api/download/grade-result
    * GET /api/download/error-files
* 文档解析：

  * python-docx
* Excel 导出：

  * openpyxl 或 xlsxwriter
* HTTP 调用模型：

  * requests 或 httpx
* 配置：

  * pyyaml（如采用 YAML 配置）

### 3.3 请求流转简化说明

1. 前端上传文件（/api/upload-files）
2. 后端保存文件、生成批次 ID、返回批次信息
3. 前端调用开始批改（/api/start-grading），传入批次 ID + 模型配置
4. 后端按批次执行：

   * 解析与校验 docx
   * 调模型评分，构造 GradeRecord 列表
   * 生成成绩表与异常清单文件
5. 前端轮询或等待响应后获取：

   * 成绩表下载链接
   * 异常文件清单下载链接
   * 核心统计信息

### 3.4 部署与运行方式

* 本地运行：

  * 安装依赖（pip 安装）
  * 启动后端服务（例如 python main.py 或 uvicorn app:app）
  * 浏览器打开本地地址（如 [http://127.0.0.1:9527）](http://127.0.0.1:9527）)
* 无需 Docker、无需云服务器，不涉及复杂运维。

---

## 四、数据库概要设计

可以有两种实现方式：

1）超轻量版本：只用文件 + Excel，不引入数据库
2）略正规一点：加一个 SQLite，用来记录批次历史与评分记录

考虑你后续可能要做统计/回看，这里给出「使用 SQLite」的概要设计，简单干净。

### 4.1 数据库选型

* SQLite

  * 单文件数据库，零配置，适合本地工具。
  * 通过 Python 自带 sqlite3 或 SQLAlchemy 操作。

### 4.2 表结构设计

1）批次表：grading_batch

* 用途：记录每次批改任务的总体信息。
* 字段：

  * id：主键，自增
  * batch_id：批次唯一字符串（如 20251211-103000-xyz）
  * created_at：创建时间
  * total_files：总文件数
  * success_count：成功评分数
  * error_count：异常文件数
  * average_score：平均分（可为空，处理完后写入）
  * status：状态（INIT / RUNNING / FINISHED / FAILED）

2）文件表：grading_file

* 用途：记录每个文件的基本信息。
* 字段：

  * id：主键，自增
  * batch_id：关联 grading_batch.batch_id
  * file_name：原始文件名
  * storage_path：在服务器上的保存路径
  * student_id：从文件名解析的学号（可为空）
  * student_name：从文件名解析的姓名（可为空）
  * parse_status：解析状态（OK / FORMAT_ERROR / PARSE_ERROR / EMPTY_CONTENT）
  * parse_error_message：解析异常信息（如有）

3）评分记录表：grading_record

* 用途：记录每份作业的最终评分结果。
* 字段：

  * id：主键，自增
  * batch_id：关联 grading_batch.batch_id
  * file_id：关联 grading_file.id
  * score：总分（数值）
  * comment：总评语
  * dimension_structure：结构分（整数）
  * dimension_content：内容分（整数）
  * dimension_expression：表达分（整数）
  * raw_text_length：正文字数
  * model_name：模型名称（可选）
  * status：评分状态（OK / MODEL_ERROR / PARSE_ERROR）
  * error_message：错误说明（如果模型返回异常或 JSON 解析失败）

说明：
如果你觉得太麻烦，也可以只用文件系统 + Excel，不建数据库。但答辩或汇报时，这份数据库设计是「有的、合理的」，实现可以按需要简化。

---

## 五、非功能需求

### 5.1 性能

* 适用规模：建议单批次处理 30–200 份作业。
* 受限因素主要是大模型 API 调用时间：

  * 默认串行处理，每份作业 5–15 秒属于正常范围。
  * 可以预留简单并行（多线程）扩展点，但不是首要目标。
* 内存：

  * 每次只在内存中处理一个文件的正文，处理完即可释放。
  * 不把所有正文一次性堆在内存里。

### 5.2 易用性

* 教师打开页面后，只需要按以下顺序操作：

  1. 选择作业文件
  2. 填写或确认模型 API 信息
  3. 点击“开始批改”
  4. 等待结果提示并下载 Excel
* 所有提示文本使用简洁中文，避免技术黑话。
* 出错时给出明确文案，例如：

  * “无法解析该 Word 文件，可能已损坏”
  * “模型调用失败，请检查 API Key 或网络”

### 5.3 安全与隐私

* 作业内容只在本机存储和处理，不上传到第三方存储服务。
* API Key：

  * 建议仅存储在前端 localStorage 或后端内存中，不落盘。
  * 前后端通信仅在本地（127.0.0.1），风险较低。

### 5.4 可维护性与扩展性

* 模块边界清晰：

  * 文件解析、AI 调用、结果导出各自独立，互相通过数据结构交互。
* 未来扩展方向：

  * 增加更多评分模版（如不同课程类型）
  * 增加支持 PDF（通过 OCR 或 pdfminer）
  * 增加简单的历史批次查看页面

### 5.5 约束与不做的内容

* 不做：

  * 微服务架构、负载均衡、云部署等复杂架构
  * 多角色权限控制、用户登录注册
  * 高并发、多用户共用场景
* 部署方式固定为：

  * 本机安装 Python 依赖
  * 启动 Web 服务
  * 浏览器访问本机地址使用
